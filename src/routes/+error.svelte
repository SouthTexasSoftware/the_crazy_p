<script lang="ts">
	import { page } from '$app/stores';
	import { alertStore } from './customStores';

	let sending = false;
	let sent = false;
	let formElem: HTMLFormElement | undefined;

	console.log($page);

	async function sendErrorReport() {
		if (sending) return;
		sending = true;

		let formData = new FormData(formElem);
		let addedDetails;
		if (formElem) {
			addedDetails = formData.get('details');
		}
		addedDetails = addedDetails == null ? 'None Added' : addedDetails;

		let errorObject = {
			details: addedDetails,
			code: $page.status.toString(),
			message: $page.error?.message,
			pathname: $page.url.href
		};

		let serverRequest = await fetch('/api/trigger-email', {
			method: 'POST',
			body: JSON.stringify({
				payload: errorObject,
				type: 'error'
			}),
			headers: {
				'Content-Type': 'application/json'
			}
		});

		let response = await serverRequest.json();

		if (response.error) {
			console.log(response.code);

			alertStore.set({
				show: true,
				type: 'error',
				message: "Uh Oh! That didn't work either..."
			});

			return;
		}

		alertStore.set({
			show: true,
			type: 'success',
			message: 'Success! Report sent.'
		});

		sending = false;
		sent = true;
	}
</script>

<div class="wrapper">
	<h2>Uh Oh!</h2>

	<div class="sad-cow">
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 480"
			><path
				fill="#a07765"
				d="M471.516,222.469c-4.781-39.418-44.148-67.971-87.415-49.991c-2.08-3.33-4.25-6.6-6.52-9.79	c15.68-9.89,35.44-27.58,42.22-56.21c6.54-27.64-1.03-57.03-19.33-79.62c-7.83-9.68-23.43-4.17-23.4,8.28	c0.079,35.646-19.082,66.06-54.66,75.62c-51.992-31.657-113.323-31.561-165.24,0.26l-0.28-0.45	c-34.928-9.717-54.039-39.781-53.96-75.43c0.03-12.45-15.57-17.96-23.4-8.28c-33.349,41.167-30.225,102.295,22.89,135.83	c-2.27,3.19-4.44,6.46-6.52,9.79c-43.267-17.98-82.636,10.572-87.418,49.99c-0.574,4.73,1.804,9.328,5.919,11.729	c16.058,9.367,34.827,13.602,54.129,11.261c-8.248,52.811,6.544,105.192,46.59,142.52c18.68,40.92,67.54,70.11,124.88,70.11	c57.34,0,106.2-29.19,124.88-70.11c40.045-37.327,54.838-89.707,46.59-142.52c19.302,2.341,38.069-1.895,54.127-11.262	C469.713,231.796,472.089,227.199,471.516,222.469z"
			/><path
				fill="#cbe3fa"
				d="M400.47,26.858c33.415,41.248,30.136,102.384-22.89,135.83c-14.85-20.93-33.64-38.81-55.17-51.93	c35.561-9.555,54.738-40.003,54.66-75.62C377.04,22.688,392.64,17.178,400.47,26.858z"
			/><path
				fill="#cbe3fa"
				d="M156.89,110.568l0.28,0.45c-21.35,13.09-40,30.88-54.75,51.67c-15.68-9.9-35.45-27.58-42.22-56.21	c-6.54-27.64,1.03-57.03,19.33-79.62c7.83-9.68,23.43-4.17,23.4,8.28C102.852,70.791,121.998,100.861,156.89,110.568z"
			/><path
				fill="#c79a83"
				d="M364.88,387.978c-18.68,40.92-67.54,70.11-124.88,70.11s-106.2-29.19-124.88-70.11	c-31.798-69.652,32.378-143.89,124.88-143.89C333.791,244.088,396.239,319.288,364.88,387.978z"
			/><path
				fill="#eef7ff"
				d="M375.05,117.328c-7.82,7.46-16.42,12.1-24.11,15.01c-8.81-8.13-18.36-15.39-28.53-21.58	c35.561-9.555,54.738-40.003,54.66-75.62c-0.03-12.45,15.57-17.96,23.4-8.28C408.634,36.953,395.907,97.42,375.05,117.328z"
			/><path
				fill="#eef7ff"
				d="M124.21,136.988c-7.96,7.87-15.25,16.49-21.79,25.7c-15.68-9.9-35.45-27.58-42.22-56.21	c-6.755-28.547,1.873-58.749,19.481-79.804c5.83-6.972,17.064-0.37,13.913,8.155C80.472,70.344,89.414,110.525,124.21,136.988z"
			/><path
				fill="#b58c77"
				d="M95.9,172.478c-2.94,4.72-5.7,9.57-8.24,14.53c-25.883,0.731-47.235,17.617-55.724,40.98	c-2.425,6.673-10.26,10.453-17.535,6.209c-4.11-2.4-6.489-6.999-5.919-11.729C13.272,183.049,52.63,154.498,95.9,172.478z"
			/><path
				fill="#e0b7a3"
				d="M245.1,277.632c-54.659,12.759-97.121,53.946-99.064,100.443c-0.768,18.382-26.05,22.58-32.817,5.472	c-26.767-67.669,35.425-140.193,128.128-139.453C261.41,244.254,264.639,273.071,245.1,277.632z"
			/><path
				fill="#b58c77"
				d="M213.671,89.364c30.35-5.312,43.079,37.209,14.701,49.211c-33.037,13.972-62.382,39.14-83.472,72.903	c-20.576,32.969-30.299,70.787-29.55,102.23c-11.145,24.024-11.054,50.56-0.23,74.27c-83.526-77.856-53.357-218.465,42.05-276.96	C175.387,99.853,194.463,92.726,213.671,89.364z"
			/><path
				fill="#b5d5f5"
				d="M384.207,158.181c-2.257,1.654-4.48,3.153-6.627,4.508c-14.85-20.93-33.64-38.81-55.17-51.93	c4.192-1.124,8.932-2.754,13.845-5.137c2.682-1.301,5.864-1.032,8.265,0.734c15.317,11.263,29.318,24.999,41.238,40.484	C388.496,150.396,387.827,155.527,384.207,158.181z"
			/><path
				fill="#785546"
				d="M417.846,245.994c-2.117-0.1-4.244-0.278-6.376-0.535c-4.05-25.98-13.59-50.9-27.37-72.98	c3.288-1.367,6.551-2.465,9.778-3.307c3.547-0.925,7.292,0.591,9.08,3.791c10.834,19.395,18.834,40.784,23.182,63.556	C427.113,241.611,423.026,246.238,417.846,245.994z"
			/><path
				fill="#b5d5f5"
				d="M157.17,111.018c-21.35,13.09-40,30.88-54.75,51.67c-2.148-1.356-4.373-2.858-6.631-4.516	c-3.605-2.647-4.292-7.774-1.563-11.318c16.819-21.841,33.698-34.911,41.337-40.49c2.374-1.734,5.514-2.028,8.16-0.746	c4.648,2.253,9.146,3.831,13.168,4.95L157.17,111.018z"
			/><path
				fill="#785546"
				d="M95.9,172.478c-13.78,22.08-23.32,47-27.37,72.98c-2.133,0.257-4.259,0.436-6.377,0.535	c-5.177,0.244-9.266-4.379-8.294-9.47c4.293-22.491,12.197-43.895,23.189-63.557c1.788-3.199,5.532-4.717,9.078-3.792	C89.353,170.016,92.617,171.111,95.9,172.478z"
			/><path
				d="M273.142,289.694c1.991-3.944,0.408-8.756-3.536-10.747c-3.945-1.991-8.756-0.408-10.747,3.536 c-3.559,7.05-10.961,11.605-18.858,11.605s-15.299-4.555-18.858-11.605c-1.991-3.944-6.802-5.528-10.747-3.536 c-3.944,1.991-5.527,6.803-3.536,10.747C220.579,316.871,259.424,316.866,273.142,289.694z"
			/><path
				d="M192,208.088v11c0,4.418,3.582,8,8,8s8-3.582,8-8v-11c0-4.418-3.582-8-8-8S192,203.67,192,208.088z"
			/><path
				d="M272,208.088v11c0,4.418,3.582,8,8,8s8-3.582,8-8v-11c0-4.418-3.582-8-8-8S272,203.67,272,208.088z"
			/><path
				d="M222.685,149.459c-3.11-3.139-8.175-3.164-11.314-0.055c-8.227,8.147-19.282,12.398-30.889,11.699 c-4.417-0.282-8.201,3.094-8.467,7.504c-0.266,4.41,3.094,8.201,7.504,8.467c16.207,0.982,31.709-5.01,43.111-16.301 C225.769,157.663,225.794,152.599,222.685,149.459z"
			/><path
				d="M300.482,177.074c4.41-0.266,7.77-4.057,7.504-8.467c-0.266-4.41-4.061-7.784-8.467-7.504 c-11.672,0.704-22.713-3.602-30.889-11.699c-3.14-3.108-8.205-3.085-11.314,0.055c-3.109,3.14-3.084,8.205,0.055,11.314 C268.658,171.95,284.1,178.06,300.482,177.074z"
			/><path
				d="M180.706,374.026c2.727,3.478,7.756,4.084,11.232,1.357c12.857-10.086,39.053-12.294,48.063-12.294 c31.508,0,47.763,12.068,48.079,12.307c1.461,1.14,3.195,1.693,4.916,1.693c7.551,0,10.935-9.593,4.944-14.294 c-0.817-0.642-20.446-15.707-57.939-15.707c-1.548,0-38.145,0.179-57.938,15.706C178.586,365.521,177.979,370.55,180.706,374.026z"
			/><path
				d="M387.327,162.772c-13.104-19.619-29.291-36.596-47.475-50c29.91-14.542,45.297-44.615,45.215-77.652 c-0.008-3.3,2.382-4.506,3.411-4.872c1.038-0.369,3.677-0.949,5.775,1.643c23.479,28.994,27.788,70.768,3.81,101.889 c-2.697,3.5-2.046,8.523,1.454,11.22c3.522,2.714,8.54,2.023,11.22-1.454c28.554-37.059,24.042-87.033-4.049-121.724 c-12.577-15.53-37.67-6.659-37.621,13.338c0.077,30.762-15.409,57.328-45.49,66.908c-52.489-30.619-114.565-30.672-167.141-0.007 c-30.377-9.679-45.578-36.461-45.502-66.901c0.049-19.983-25.036-28.877-37.621-13.338c-27.977,34.55-32.706,84.53-4.051,121.722 c2.69,3.491,7.711,4.158,11.22,1.455c3.5-2.697,4.151-7.72,1.455-11.22C57.92,102.605,62.323,60.817,85.748,31.891 c2.097-2.59,4.738-2.012,5.775-1.643c1.028,0.365,3.419,1.572,3.411,4.871c-0.082,33.106,15.377,63.148,45.212,77.654 c-18.176,13.398-34.365,30.373-47.472,49.998C44.463,147.165,0.319,182.39,0,230.035c-0.018,2.625,1.254,5.091,3.402,6.6 c7.52,5.282,15.68,9.448,24.256,12.385c4.179,1.43,8.729-0.797,10.16-4.978c1.431-4.18-0.797-8.729-4.978-10.16 c-5.811-1.989-11.398-4.661-16.662-7.962c2.587-33.093,32.63-58.209,67.836-49.008C57.243,224.921,49.621,283.862,69.68,335.15 c1.609,4.115,6.249,6.146,10.364,4.536c4.115-1.609,6.146-6.25,4.537-10.364c-6.796-17.375-10.241-36.18-10.241-55.894 c0-123.263,130.677-227.652,243.418-155.969c0.183,0.116,0.365,0.232,0.552,0.341c92.177,53.742,119.69,188.415,41.117,264.326 c-0.798,0.771-1.361,1.516-1.847,2.578c-19.451,42.499-69.8,65.385-117.579,65.385c-65.573,0-125-41.972-125-99 c0-54.589,56.075-99,125-99c59.303,0,110.84,33.396,122.545,79.409c1.089,4.283,5.445,6.872,9.725,5.781 c4.282-1.089,6.87-5.443,5.781-9.725c-6.542-25.716-23.953-49.046-49.027-65.694c-54.233-36.008-135.565-34.914-188.083,7.337 c-63.288,50.917-53.123,135.391,18.151,176.128c74.324,42.479,179.17,17.242,212.359-52.563 c59.291-56.329,64.207-144.705,24.533-215.85c35.04-9.157,65.237,15.764,67.836,49.008c-5.259,3.299-10.843,5.969-16.649,7.958 c-4.18,1.432-6.408,5.981-4.976,10.161c1.432,4.18,5.98,6.408,10.161,4.976c8.571-2.936,16.727-7.101,24.242-12.379 c2.147-1.509,3.419-3.975,3.401-6.6C479.682,182.468,435.642,147.133,387.327,162.772z"
			/></svg
		>
	</div>

	{#if sent}
		<p>Thanks for your help!</p>
	{:else}
		{#if $page.error?.message == 'Not Found'}
			<p>The page you are looking for was not found.</p>
		{:else}
			<p>Something went wrong on our end. Sorry!</p>
		{/if}
		<form on:submit|preventDefault={sendErrorReport} bind:this={formElem}>
			<textarea id="details" placeholder="Anything to add? (optional)" />
			<button type="submit" class="btn btn-accent"
				>{#if sending}
					<div class="button-spinner" />
				{:else}
					SEND ERROR REPORT
				{/if}</button
			>
		</form>
	{/if}
</div>

<style>
	.wrapper {
		height: 800px;
		width: 100vw;
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
	}
	h2 {
		font-family: lato-bold;
		font-size: 26px;
	}
	p {
		margin-top: 15px;
		font-family: lato-light;
		font-size: 20px;
	}
	button {
		margin-top: 15px;
		width: 200px;
	}
	.button-spinner {
		content: '';
		border-radius: 50%;
		border-top: 2px solid hsl(var(--ac));
		border-right: 2px solid transparent;
		width: 20px;
		height: 20px;
		animation-name: spinning;
		animation-duration: 1s;
		animation-iteration-count: infinite;
		animation-timing-function: linear;
		opacity: 1;
		transition: all 0.2s;
		margin-left: 0px;
	}
	form {
		display: flex;
		flex-direction: column;
		justify-content: center;
		align-items: center;
		margin-top: 25px;
	}
	textarea {
		border: 1px solid hsl(var(--n));
		background-color: hsl(var(--bg));
		outline: none;
		padding: 8px 14px;
		margin: 10px 0;
		width: 500px;
		max-height: 200px;
		border-radius: 1px;
		font-family: lato-regular;
		font-size: 20px;
	}
	textarea::placeholder {
		font-family: lato-light;
		color: rgb(99, 99, 99);
	}
	.sad-cow {
		width: 300px;
	}

	@media screen and (max-width: 800px) {
		textarea {
			width: 80vw;
		}
	}
	@keyframes spinning {
		0% {
			transform: rotate(0deg);
		}
		100% {
			transform: rotate(360deg);
		}
	}
</style>
